<!doctype html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="application-name" content="TiddlyWiki Plugin Library" />
<meta name="application-version" content="v0.0.0" />
<meta name="copyright" content="Copyright 2015 Jeremy Ruston" />
<link id="faviconLink" rel="shortcut icon" href="favicon.ico">
<title>Plugin Library</title>
<script type="module">
(async function () {
    "use strict";

    /**
     * Global variables initialized during script execution.
     * @type {Object[]} assetList - List of assets fetched from the server.
     */
    let assetList = [];

    /**
     * Main execution block
     */
    try {
        const fetchedData = await fetchData();
        if (fetchedData) {
            assetList = fetchedData.assetList;
            attachMessageListener(fetchedData.libraryUrl);
        } else {
            console.error("Failed to fetch data. Initialization aborted.");
        }
    } catch (error) {
        console.error("Critical error during initialization:", error);
    }

    /**
     * Fetch data from the server.
     * @returns {Promise<Object|null>} - Returns the fetched data or null on failure.
     */
    async function fetchData() {
        console.info("Starting data fetch...");

        const queryParams = new URLSearchParams(window.location.search);
        const libraryUrl = queryParams.get("libraryUrl");

        if (!libraryUrl) {
            console.error("No 'libraryUrl' found in query parameters. Aborting fetch.");
            return null;
        }

        try {
            const response = await fetch(`${libraryUrl}/tiddlers.json?title=assetList`);
            if (!response.ok) {
                throw new Error(`HTTP error ${response.status}`);
            }

            const assetList = parseAssetList(await response.json());
            console.info("Data fetched successfully from:", libraryUrl);

            return { assetList, libraryUrl };
        } catch (error) {
            console.error("Failed to fetch data from server:", { libraryUrl, error });
            return null;
        }
    }

    /**
     * Parse the asset list from the fetched data.
     * @param {Array} rawAssetList - The raw asset list from the server.
     * @returns {Array} - Parsed and validated asset list.
     */
    function parseAssetList(rawAssetList) {
        if (!Array.isArray(rawAssetList) || !rawAssetList[0]?.text) {
            console.error("Invalid asset list format");
            return [];
        }
        try {
            return JSON.parse(`[${rawAssetList[0].text}]`);
        } catch (error) {
            console.error("Failed to parse asset list:", { rawAssetList, error });
            return [];
        }
    }

    /**
     * Attach a message event listener to handle incoming messages.
     * @param {string} libraryUrl - The base URL for the library.
     */
    function attachMessageListener(libraryUrl) {
        console.info("Attaching message event listener...");

        const allowedOrigin = "https://your-allowed-origin.com"; // Replace with your origin

        window.addEventListener(
            "message",
            async function handleMessage(event) {
                if (event.origin !== allowedOrigin) {
                    console.warn("Ignoring message from untrusted origin:", event.origin);
                    return;
                }

                console.log("Message received from:", event.origin);
                console.debug("Message data:", event.data);

                if (!event.data || typeof event.data.verb !== "string") {
                    console.warn("Ignoring message with invalid structure.");
                    return;
                }

                try {
                    switch (event.data.verb) {
                        case "GET":
                            await handleGetRequest(event, libraryUrl);
                            break;
                        default:
                            console.warn("Unhandled message verb:", event.data.verb);
                    }
                } catch (error) {
                    console.error("Error processing message:", error);
                }
            },
            false
        );
    }

    /**
     * Handle GET requests received via the postMessage API.
     * @param {MessageEvent} event - The incoming message event.
     * @param {string} libraryUrl - The base URL for the library.
     */
    async function handleGetRequest(event, libraryUrl) {
        if (event.data.url === "recipes/library/tiddlers.json") {
            // Return the full asset list
            sendMessage(event.source, {
                verb: "GET-RESPONSE",
                status: "200",
                cookies: event.data.cookies,
                url: event.data.url,
                type: "application/json",
                body: JSON.stringify(assetList, null, 4),
            });
        } else if (event.data.url.startsWith("recipes/library/tiddlers/")) {
            // Handle individual tiddler requests
            const pluginTitle = removePrefix(event.data.url, "recipes/library/tiddlers/")
                .replace(".json", "");
            const pluginUrl = `${libraryUrl}/tiddlers.json?title=${pluginTitle}&include_system=1`;

            console.log("Fetching individual plugin data from:", pluginUrl);

            try {
                const pluginResponse = await fetch(pluginUrl);
                if (!pluginResponse.ok) {
                    throw new Error(`HTTP error ${pluginResponse.status}`);
                }
                const pluginData = await pluginResponse.json();
                const cleanedResponse = stripOuterBrackets(pluginData);

                sendMessage(event.source, {
                    verb: "GET-RESPONSE",
                    status: "200",
                    cookies: event.data.cookies,
                    url: event.data.url,
                    type: "application/json",
                    body: cleanedResponse,
                });
            } catch (error) {
                console.error("Failed to fetch plugin data:", { pluginUrl, error });
                sendMessage(event.source, {
                    verb: "GET-RESPONSE",
                    status: "404",
                    cookies: event.data.cookies,
                    url: event.data.url,
                    type: "text/plain",
                    body: "Not found",
                });
            }
        } else {
            // Unknown URL, return 404
            console.warn("Unknown GET request URL:", event.data.url);
            sendMessage(event.source, {
                verb: "GET-RESPONSE",
                status: "404",
                cookies: event.data.cookies,
                url: event.data.url,
                type: "text/plain",
                body: "Not found",
            });
        }
    }

    /**
     * Send a message to a target window.
     * @param {Window} targetWindow - The target window to send the message to.
     * @param {Object} message - The message object to send.
     */
    function sendMessage(targetWindow, message) {
        targetWindow.postMessage(message, "*");
        console.debug("Message sent:", message);
    }

    /**
     * Remove a specified prefix from a string.
     * @param {string} string - The input string.
     * @param {string} prefix - The prefix to remove.
     * @returns {string} - The string without the prefix.
     */
    function removePrefix(string, prefix) {
        return string.startsWith(prefix) ? string.substring(prefix.length) : string;
    }

    /**
     * Strip outer brackets from a JSON response.
     * @param {Object|string} json - The JSON data.
     * @returns {string} - The cleaned JSON string.
     */
    function stripOuterBrackets(json) {
        try {
            const parsed = typeof json === "string" ? JSON.parse(json) : json;
            if (Array.isArray(parsed) && parsed.length === 1) {
                return JSON.stringify(parsed[0], null, 4);
            }
            return JSON.stringify(parsed, null, 4);
        } catch (error) {
            console.error("Error parsing JSON:", error);
            return json; // Return original JSON if parsing fails
        }
    }
})();

</script>
</head>
<body>
<h1>HelloThere</h1>
<p>This is the TiddlyHost plugin library. It is not intended to be opened directly in the browser.</p>
<p>See <a href="https://tiddlywiki.com/" target="_blank">https://tiddlywiki.com/</a> for details of how to install plugins.</p>
</body>
</html>
